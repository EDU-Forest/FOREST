/**
 * @license React
 * react-server-dom-webpack-plugin.js
 *
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */

'use strict';

'use strict';var q=require("path"),t=require("url"),x=require("neo-async"),y=require("webpack/lib/dependencies/ModuleDependency"),z=require("webpack/lib/dependencies/NullDependency"),A=require("webpack/lib/Template"),B=require("webpack");const C=Array.isArray;class D extends y{constructor(b){super(b)}get type(){return"client-reference"}}const E=require.resolve("../client.browser.js");
class F{constructor(b){this.ssrManifestFilename=this.clientManifestFilename=this.chunkName=this.clientReferences=void 0;if(!b||"boolean"!==typeof b.isServer)throw Error("React Server Plugin: You must specify the isServer option as a boolean.");if(b.isServer)throw Error("TODO: Implement the server compiler.");b.clientReferences?"string"!==typeof b.clientReferences&&C(b.clientReferences)?this.clientReferences=b.clientReferences:this.clientReferences=[b.clientReferences]:this.clientReferences=[{directory:".",
recursive:!0,include:/\.(js|ts|jsx|tsx)$/}];"string"===typeof b.chunkName?(this.chunkName=b.chunkName,/\[(index|request)\]/.test(this.chunkName)||(this.chunkName+="[index]")):this.chunkName="client[index]";this.clientManifestFilename=b.clientManifestFilename||"react-client-manifest.json";this.ssrManifestFilename=b.ssrManifestFilename||"react-ssr-manifest.json"}apply(b){const n=this;let p,u=!1;b.hooks.beforeCompile.tapAsync("React Server Plugin",(c,a)=>{c=c.contextModuleFactory;const e=b.resolverFactory.get("context",
{});n.resolveAllClientFiles(b.context,e,b.inputFileSystem,c,function(d,h){d?a(d):(p=h,a())})});b.hooks.thisCompilation.tap("React Server Plugin",(c,a)=>{a=a.normalModuleFactory;c.dependencyFactories.set(D,a);c.dependencyTemplates.set(D,new z.Template);c=e=>{e.hooks.program.tap("React Server Plugin",()=>{const d=e.state.module;if(d.resource===E&&(u=!0,p))for(let k=0;k<p.length;k++){const l=p[k];var h=n.chunkName.replace(/\[index\]/g,""+k).replace(/\[request\]/g,A.toPath(l.userRequest));h=new B.AsyncDependenciesBlock({name:h},
null,l.request);h.addDependency(l);d.addBlock(h)}})};a.hooks.parser.for("javascript/auto").tap("HarmonyModulesPlugin",c);a.hooks.parser.for("javascript/esm").tap("HarmonyModulesPlugin",c);a.hooks.parser.for("javascript/dynamic").tap("HarmonyModulesPlugin",c)});b.hooks.make.tap("React Server Plugin",c=>{c.hooks.processAssets.tap({name:"React Server Plugin",stage:B.Compilation.PROCESS_ASSETS_STAGE_REPORT},function(){if(!1===u)c.warnings.push(new B.WebpackError("Client runtime at react-server-dom-webpack/client was not found. React Server Components module map file "+
n.clientManifestFilename+" was not created."));else{var a={},e={};c.chunkGroups.forEach(function(h){function k(f,g){if(/\.(js|ts)x?$/.test(g.resource)){var r=c.moduleGraph.getExportsInfo(g).getProvidedExports(),m=t.pathToFileURL(g.resource).href;if(void 0!==m){const v={};a[m]={id:f,chunks:l,name:"*"};v["*"]={specifier:m,name:"*"};a[m+"#"]={id:f,chunks:l,name:""};v[""]={specifier:m,name:""};Array.isArray(r)&&r.forEach(function(w){a[m+"#"+w]={id:f,chunks:l,name:w};v[w]={specifier:m,name:w}});e[f]=v}}}
const l=h.chunks.map(function(f){return f.id});h.chunks.forEach(function(f){f=c.chunkGraph.getChunkModulesIterable(f);Array.from(f).forEach(function(g){const r=c.chunkGraph.getModuleId(g);k(r,g);g.modules&&g.modules.forEach(m=>{k(r,m)})})})});var d=JSON.stringify(a,null,2);c.emitAsset(n.clientManifestFilename,new B.sources.RawSource(d,!1));d=JSON.stringify(e,null,2);c.emitAsset(n.ssrManifestFilename,new B.sources.RawSource(d,!1))}})})}resolveAllClientFiles(b,n,p,u,c){x.map(this.clientReferences,(a,
e)=>{"string"===typeof a?e(null,[new D(a)]):n.resolve({},b,a.directory,{},(d,h)=>{if(d)return e(d);u.resolveDependencies(p,{resource:h,resourceQuery:"",recursive:void 0===a.recursive?!0:a.recursive,regExp:a.include,include:void 0,exclude:a.exclude},(k,l)=>{if(k)return e(k);k=l.map(f=>{var g=q.join(h,f.userRequest);g=new D(g);g.userRequest=f.userRequest;return g});e(null,k)})})},(a,e)=>{if(a)return c(a);a=[];for(let d=0;d<e.length;d++)a.push.apply(a,e[d]);c(null,a)})}}module.exports=F;
